# æ©ç ç›‘ç£æŸå¤±æ¶æ„åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## 1. å½“å‰æ¶æ„åˆ†æ

### 1.1 æ©ç ç”Ÿæˆæœºåˆ¶

**SpatialMaskHead_IMP** (`aggregator.py` Layer 7ä¹‹å)ï¼š
- **è¾“å…¥**: `tokens [B, S, P, C]` (æ¥è‡ªç¬¬7å±‚çš„tokenç‰¹å¾)
- **è¾“å‡º**: 
  - `m_logit [B*S, 1, H, W]`: æ©ç logitsï¼ˆåŠ¨æ€åŒºåŸŸçš„é¢„æµ‹ï¼‰
  - `key_bias_1d [B, S*P]`: ç”¨äºattentionçš„biasï¼ˆæŠ‘åˆ¶åŠ¨æ€åŒºåŸŸï¼‰
  - `cam_row_mask [B, S*P]`: ç›¸æœº/æ³¨å†Œtokenä½ç½®çš„bool mask

**å…³é”®å‘ç°**ï¼š
```python
# åœ¨ SpatialMaskHead_IMP.forward() ä¸­ï¼š
m_logit = self.head0(h0)  # [B*S, 1, H, W] - è¿™æ˜¯æ©ç çš„logitsï¼
suppress = torch.sigmoid(-m_logit / tau)  # [B*S, 1, H, W] - è½¬æ¢ä¸ºæŠ‘åˆ¶å€¼
# ä½†æ˜¯ m_logit æ²¡æœ‰è¢«ä¿å­˜æˆ–è¾“å‡ºåˆ° predictions ä¸­
```

### 1.2 å½“å‰è¾“å‡ºç»“æ„

**predictions å­—å…¸**ï¼ˆæ¥è‡ª `vggt.py`ï¼‰ï¼š
```python
{
    "pose_enc": [B, V, 9],           # ç›¸æœºå‚æ•°
    "pose_enc_list": list,           # è¿­ä»£åˆ—è¡¨
    "depth": [B, T, V, H, W, 1],     # æ·±åº¦å›¾
    "depth_conf": [B, T, V, H, W],   # æ·±åº¦ç½®ä¿¡åº¦
    "world_points": [B, T, V, H, W, 3],  # 3Dç‚¹
    "world_points_conf": [B, T, V, H, W], # ç‚¹ç½®ä¿¡åº¦
    "track": [B, T, V, N, 2],        # è·Ÿè¸ªç‚¹ï¼ˆå¦‚æœæä¾›query_pointsï¼‰
    "vis": [B, T, V, N],             # å¯è§æ€§
    "conf": [B, T, V, N],            # ç½®ä¿¡åº¦
    # âŒ ç¼ºå°‘: "mask_logits" æˆ– "dynamic_mask"
}
```

### 1.3 æ•°æ®é›†æ”¯æŒ

ä» `train_mv_page4d_lite.py` çœ‹ï¼š
- **SegAnyMo mask GT** å¯ä»¥åŠ è½½ï¼ˆå¦‚æœæä¾› `seganymo_dir`ï¼‰
- æ ¼å¼: `[B, T, V, H, W]`, å€¼åŸŸ `[0, 1]`, `1` è¡¨ç¤ºåŠ¨æ€åŒºåŸŸ
- é»˜è®¤ï¼š`use_seganymo_mask=False`ï¼ˆå¦‚æœæ•°æ®é›†ä¸­æ²¡æœ‰maskï¼Œå¯ä»¥ä¸ä½¿ç”¨ï¼‰

## 2. æ˜¯å¦éœ€è¦æ©ç ç›‘ç£æŸå¤±ï¼Ÿ

### 2.1 æ”¯æŒä½¿ç”¨æ©ç ç›‘ç£çš„ç†ç”±

âœ… **ä¼˜ç‚¹**ï¼š
1. **æå‡åŠ¨æ€åŒºåŸŸæ£€æµ‹**ï¼šå¦‚æœæœ‰SegAnyMo GTï¼Œç›‘ç£å¯ä»¥æ˜¾è‘—æå‡maské¢„æµ‹å‡†ç¡®æ€§
2. **æ”¹å–„å‡ ä½•æ¨ç†**ï¼šæ›´å‡†ç¡®çš„åŠ¨æ€/é™æ€åŒºåŸŸåˆ’åˆ†æœ‰åŠ©äºï¼š
   - æ·±åº¦ä¼°è®¡ï¼ˆé™æ€åŒºåŸŸæ›´ç¨³å®šï¼‰
   - ç›¸æœºä¼°è®¡ï¼ˆå‡å°‘åŠ¨æ€ç‰©ä½“å¹²æ‰°ï¼‰
   - å¤šè§†è§’ä¸€è‡´æ€§ï¼ˆé™æ€åŒºåŸŸçš„ä¸€è‡´æ€§çº¦æŸæ›´å¯é ï¼‰
3. **æ¶æ„å·²å…·å¤‡**ï¼š`SpatialMaskHead` å·²ç»åœ¨ç”Ÿæˆ mask logitsï¼Œåªéœ€æå–è¾“å‡º

### 2.2 ä¸ä½¿ç”¨æ©ç ç›‘ç£çš„ç†ç”±

âŒ **ç¼ºç‚¹/å¯é€‰æ€§**ï¼š
1. **æ— ç›‘ç£ä¹Ÿèƒ½å·¥ä½œ**ï¼šå½“å‰æ¶æ„é€šè¿‡ `spatial_mask_head` å·²ç»å¯ä»¥è‡ªç›‘ç£å­¦ä¹ åŠ¨æ€åŒºåŸŸ
2. **æ•°æ®é›†å¯èƒ½æ²¡æœ‰GT**ï¼šå¦‚æœæ•°æ®é›†ä¸­æ²¡æœ‰SegAnyMo maskï¼Œç›‘ç£æŸå¤±æ— æ³•ä½¿ç”¨
3. **è®¡ç®—å¼€é”€**ï¼šå¢åŠ æ©ç ç›‘ç£ä¼šå¢åŠ è®¡ç®—å’Œå†…å­˜å¼€é”€

### 2.3 ç»“è®º

**æ¨èæ–¹æ¡ˆï¼šæ¡ä»¶ä½¿ç”¨æ©ç ç›‘ç£**
- **å¦‚æœæœ‰SegAnyMo GT**ï¼šä½¿ç”¨æ©ç ç›‘ç£æŸå¤±ï¼ˆæ¨èï¼‰
- **å¦‚æœæ²¡æœ‰GT**ï¼šä¸ä½¿ç”¨æ©ç ç›‘ç£ï¼Œè®©æ¨¡å‹è‡ªç›‘ç£å­¦ä¹ 

## 3. è§£å†³æ–¹æ¡ˆï¼šå¦‚ä½•å®ç°æ©ç ç›‘ç£

### 3.1 æ–¹æ¡ˆAï¼šä» SpatialMaskHead æå– mask_logitsï¼ˆæ¨èï¼‰

**ä¿®æ”¹ aggregator.py**ï¼š
åœ¨ç”Ÿæˆ mask åï¼Œä¿å­˜ `m_logit` åˆ°ä¸­é—´å˜é‡ï¼Œç„¶ååœ¨ forward è¿”å›æ—¶æ·»åŠ åˆ°è¾“å‡ºã€‚

**æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `aggregator.forward()` æ–¹æ³•ï¼Œä¿å­˜ `m_logit`
2. ä¿®æ”¹ `vggt.py` çš„ `forward()` æ–¹æ³•ï¼Œå°† `mask_logits` æ·»åŠ åˆ° `predictions`

### 3.2 æ–¹æ¡ˆBï¼šæ·»åŠ ç‹¬ç«‹çš„ MaskHeadï¼ˆä¸æ¨èï¼‰

åˆ›å»ºæ–°çš„ `MaskHead` æ¨¡å—ä¸“é—¨è¾“å‡ºæ©ç ï¼Œä½†ä¼šå¢åŠ å‚æ•°é‡å’Œè®¡ç®—å¼€é”€ã€‚

### 3.3 æ–¹æ¡ˆCï¼šä»ç°æœ‰çš„ loss å‡½æ•°ä¸­ç§»é™¤æ©ç ç›‘ç£ï¼ˆç®€å•ä½†æ¬¡ä¼˜ï¼‰

å¦‚æœå½“å‰æ²¡æœ‰ SegAnyMo GTï¼Œå¯ä»¥æš‚æ—¶ç¦ç”¨æ©ç ç›‘ç£æŸå¤±ã€‚

## 4. å®ç°ç»†èŠ‚

### 4.1 ä» SpatialMaskHead æå– mask_logits

éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š

1. **aggregator.py** - ä¿®æ”¹ `spatial_mask_head` è°ƒç”¨ï¼š
```python
# å½“å‰ä»£ç ï¼ˆç¬¬437-442è¡Œï¼‰ï¼š
cached_key_bias_1d, cached_cam_row_mask = self.spatial_mask_head(
    tokens.detach().clone().reshape(B, S, P, C), 
    self.patch_start_idx, H // self.patch_size, W // self.patch_size)

# éœ€è¦ä¿®æ”¹ä¸ºï¼šä¿å­˜ m_logit
mask_info = self.spatial_mask_head(
    tokens.detach().clone().reshape(B, S, P, C), 
    self.patch_start_idx, H // self.patch_size, W // self.patch_size)
cached_key_bias_1d, cached_cam_row_mask, m_logit = mask_info
# æˆ–è€…ï¼šä¿®æ”¹ SpatialMaskHead_IMP è¿”å› m_logit
```

2. **ä¿®æ”¹ SpatialMaskHead_IMP** è¿”å› `m_logit`ï¼š
```python
# åœ¨ vggt_t_mask_mlp_fin10/layers/block.py ä¸­
# ä¿®æ”¹ forward æ–¹æ³•è¿”å›ä¸‰ä¸ªå€¼ï¼š
return key_bias_1d, cam_row_mask, m_logit  # æ–°å¢ m_logit
```

3. **vggt.py** - å°† mask_logits æ·»åŠ åˆ° predictionsï¼š
```python
# åœ¨ aggregator.forward() è¿”å› mask_logits
aggregated_tokens_list, patch_start_idx, mask_logits = self.aggregator(...)

# æ·»åŠ åˆ° predictions
if mask_logits is not None:
    predictions["mask_logits"] = mask_logits  # [B, T, V, H, W] æˆ– [B, T*V, H, W]
```

## 5. æ¨èçš„å®ç°æ–¹æ¡ˆ

### 5.1 æœ€å°ä¿®æ”¹æ–¹æ¡ˆï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- åªä¿®æ”¹å¿…è¦çš„ä»£ç 
- ä¿æŒæ¶æ„ç®€æ´
- å‘åå…¼å®¹ï¼ˆå¦‚æœæ²¡æœ‰maskï¼Œè¿”å›Noneï¼‰

**æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `SpatialMaskHead_IMP.forward()` è¿”å› `m_logit`
2. åœ¨ `aggregator.forward()` ä¸­ä¿å­˜ `m_logit` å¹¶è¿”å›
3. åœ¨ `vggt.forward()` ä¸­å°† `mask_logits` æ·»åŠ åˆ° `predictions`
4. ä¿æŒ `compute_mask_supervision_loss` ä¸å˜ï¼ˆå·²ç»æ”¯æŒï¼‰

### 5.2 æ©ç logitsçš„æ ¼å¼è½¬æ¢

ä» `SpatialMaskHead_IMP` çš„è¾“å‡º `m_logit [B*S, 1, H, W]` è½¬æ¢ä¸ºå¤šè§†è§’æ ¼å¼ï¼š
- å¦‚æœ `is_multi_view=True`: `[B*S, 1, H, W]` â†’ `[B, T, V, H, W]`
- å¦‚æœ `is_multi_view=False`: `[B*S, 1, H, W]` â†’ `[B, S, 1, H, W]`

## 6. æŸå¤±è®¡ç®—ï¼ˆå·²å®ç°ï¼‰

`compute_mask_supervision_loss` å‡½æ•°å·²ç»å®ç°ï¼š
- æ”¯æŒ `mask_logits` ä» `[B, T, H, W]` åˆ° `[B, T, V, H, W]` çš„å„ç§å½¢çŠ¶
- ä½¿ç”¨ `BCEWithLogits` ä½œä¸ºä¸»è¦æŸå¤±
- å¯é€‰ï¼šè¾¹ç•ŒæŸå¤± (`compute_boundary_loss`)
- å¯é€‰ï¼šæ—¶åºä¸€è‡´æ€§æŸå¤± (`compute_temporal_consistency_loss_mask`)

## 7. æ€»ç»“ä¸å»ºè®®

### âœ… æ¨èåšæ³•

1. **å®ç°æ–¹æ¡ˆA**ï¼šä» `SpatialMaskHead` æå– `m_logit` å¹¶è¾“å‡ºåˆ° `predictions`
2. **æ¡ä»¶ä½¿ç”¨**ï¼šåªåœ¨æœ‰ SegAnyMo GT æ—¶å¯ç”¨æ©ç ç›‘ç£æŸå¤±
3. **é…ç½®æ§åˆ¶**ï¼šé€šè¿‡ `LossConfig` æ§åˆ¶æ©ç ç›‘ç£çš„å¯ç”¨/ç¦ç”¨

### ğŸ“ å®ç°ä¼˜å…ˆçº§

- **é«˜ä¼˜å…ˆçº§**ï¼šå¦‚æœéœ€è¦ä½¿ç”¨ SegAnyMo GTï¼Œå¿…é¡»å®ç°æ©ç æå–
- **ä¸­ä¼˜å…ˆçº§**ï¼šå¦‚æœæ•°æ®é›†æ²¡æœ‰ GTï¼Œå¯ä»¥æš‚æ—¶ç¦ç”¨æ©ç ç›‘ç£
- **ä½ä¼˜å…ˆçº§**ï¼šè¾¹ç•ŒæŸå¤±å’Œæ—¶åºä¸€è‡´æ€§æŸå¤±æ˜¯å¯é€‰çš„å¢å¼º

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤šè§†è§’æ ¼å¼**ï¼šç¡®ä¿ `mask_logits` çš„æ ¼å¼æ­£ç¡®å¤„ç† `[B, T, V, H, W]`
2. **å†…å­˜å¼€é”€**ï¼š`m_logit` ä¼šå¢åŠ å†…å­˜ä½¿ç”¨ï¼ˆä½†ç›¸å¯¹è¾ƒå°ï¼‰
3. **æ¢¯åº¦æµ**ï¼š`spatial_mask_head` ä½¿ç”¨ `tokens.detach()`ï¼Œæ‰€ä»¥æ¢¯åº¦ä¸ä¼šæµå›mask headï¼ˆè¿™æ˜¯è®¾è®¡å¦‚æ­¤ï¼‰

